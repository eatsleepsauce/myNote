#### 计算机性能

##### 一、什么是性能

计算机的性能需要一个标准来衡量，这个标准主要包含了两个指标：

**响应时间（Response time）**或者叫执行时间（Execution time）,想要提升响应时间这个性能指标，可以理解为让计算机“跑得更快”。

**吞吐率（Throughput）**或者带宽（Bandwidth）,想要提升这个指标，可以理解为让计算机“搬得更多”。

所以说，响应时间指的是，执行一个程序，到底需要花多少时间，花的时间越少，自然性能越好。而吞吐率是指我们在一定的时间范围内，到底能处理多少事情，这里的“事情”指计算机处理的数据或者执行的程序指令。

提升吞吐率的方法有很多，大部分的时候，我们只要添加一些机器，多堆一些硬件就好了，但是响应时间的提升没有那么容易。

我们一般把性能，定义成响应时间的倒数，也就是：

**性能 = 1 / 响应时间**

**使用响应时间来衡量性能指标，其实也有两个问题：**

（1）时间不准，因为计算机可能同时运行着好多个程序，cpu实际上不停地在各个程序之间进行切换，而且还有io操作，这些都是需要剔除的时间。

```
linux 通过time命令可以统计程序在cpu上到底花了多少时间

$ time seq 1000000 | wc -l
1000000

real  0m0.101s
user  0m0.031s
sys   0m0.016s

```

第一个是real time，也就是程序运行过程中流逝的时间（Wall Clock Time），第二个是user time 也就是cpu运行程序，在用户态执行指令的时间，第三个是sys time，是cpu运行程序，在操作系统内核里面运行指令的时间，而程序实际话费的cpu执行时间，就是user time 加上 sys time。

<img src="https://liuyang-picbed.oss-cn-shanghai.aliyuncs.com/img/0b340db019d7e389a2bde4c237ee4700.jpg" alt="0b340db019d7e389a2bde4c237ee4700" style="zoom:33%;" />

（2）即使拿到了CPU时间，也不不一定可以直接比较性能差异，因为CPU可能满载运行也可能降频运行，降频运行的时候自然花的时候多一些。

“时间”重新定义后：

**程序的CPU执行时间 =  CPU时钟周期数 × 时钟周期时间**  

将 CPU时钟周期再进一步分解，把它变成“指令数 × 每条指令的平均时钟周期数（Cycles Per Instruction，简称CPI）”，公式就变成了：

**程序的CPU执行时间 = 指令数 × CPI × 时钟周期时间（Clock Cycle Time）**

解决性能问题，主要是优化公式中的三个因子：

（1）时钟周期时间，就是计算机主频（提升主频，摩尔定律）

（2）每条指令的平均时钟周期数CPI，就是一条指令到底需要多少CPU Cycle。现代CPU通过流水线技能，让一条指令需要的CPU Cycle 尽可能地少。

（3）指令数，代表执行我们的程序到底需要多少指令，用哪些指令。

##### 二、如何提升性能

**程序的CPU执行时间 = 指令数 × CPI × 时钟周期时间（Clock Cycle Time）**

1、摩尔定律

早期是通过时钟周期来提升性能的，每隔一段时间CPU性能就会翻一番，CPU一般都被叫做 **超大规模集成电路（Very-Large-Scale Integration, VLSI）**,这些电路都是一个一个晶体管组合而成的。CPU在计算，其实就是让晶体管里的“开关”不断地去“打开”和“关闭”，来组合完成各种运算和功能。想要计算得快，一方面是在同样的面积里面多放一些晶体管，也就是 **增加密度** ；另一方，让晶体管“打开”和“关闭”得更快一点，也就是提 **升主频**。而这两者都会增加功耗，带来耗电和散热问题。

**功耗 ~= 1/2 ×负载电容×电压的平方×开关频率×晶体管数量**

<img src="https://liuyang-picbed.oss-cn-shanghai.aliyuncs.com/img/f59f2f33e308000cb5d2ad017f2ff8ed.jpeg" alt="f59f2f33e308000cb5d2ad017f2ff8ed" style="zoom: 33%;" />

功耗增加太多，就会导致CPU散热跟不上。虽然制程的优化和电压的下降，在过去20年里，让我们的CPU性能有所提升，但现在已经不行了。

2、阿姆达尔定律

通过并行提高性能，也就是增加CPU，通过提升“吞吐率”而不是“响应时间”来达到目的。不过并不是所有问题都可以通过并行提高性能。

**阿姆达尔定律：优化后的执行时间 = 受优化影响的执行时间 / 加速倍数 + 不受影响的执行时间**

<img src="https://liuyang-picbed.oss-cn-shanghai.aliyuncs.com/img/f1d05ec439e6377803df741bc07b09e5.jpeg" alt="f1d05ec439e6377803df741bc07b09e5" style="zoom:33%;" />

3、其他提升性能原则

（1）**加速大概率事件**，最典型的就是，过去几年流行的深度学习，整个计算过程中，99% 都是向量和矩阵计算，于是，工程师们通过用 GPU 替代 CPU，大幅度提升了深度学习的模型训练过程。

（2）**通过流水线提高性能**，我们把 CPU 指令执行的过程进行拆分，细化运行，也是现代 CPU 在主频没有办法提升那么多的情况下，性能仍然可以得到提升的重要原因之一。

（3）**通过预测提高性能**，通过预先猜测下一步该干什么，而不是等上一步运行的结果，提前进行运算，也是让程序跑得更快一点的办法。

