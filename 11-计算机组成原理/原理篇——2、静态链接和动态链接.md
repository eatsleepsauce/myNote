#### 静态链接和动态链接

##### 一、编译、链接和装载

C语言程序到可以在计算机上执行，由两个部分组成：

第一部分由**编译（compile）、汇编（assemble）以及链接（link）**三个阶段组成，在这三个阶段完成之后，我们就生成了一个可执行文件。汇编之后得到的不是一个可执行文件，而是目标文件，只有通过**连接器（linker）**把多个目标文件以及调用的各种函数库链接起来，才能得到一个可执行文件。

第二部分，通过**装载器（loader）**把可执行文件装载（load）到内存中，CPU从内存中读取指令和数据，来开始真正执行程序。

<img src="https://liuyang-picbed.oss-cn-shanghai.aliyuncs.com/img/997341ed0fa9018561c7120c19cfa2a7.jpg" alt="997341ed0fa9018561c7120c19cfa2a7" style="zoom: 33%;" />

##### 二、ELF格式和链接

程序最终是通过装载器变成指令和数据的，所以我们生成的可以执行代码并不仅仅是一条条指令。

可执行代码objdump出来的内容和目标代码dump出来的差不多，但是长了很多，linux下，可执行文件和目标文件所使用都是一种叫 ELF（executable and linkable file format）的文件格式，这里面不仅存放了编译成的汇编指令，还保存了很多别的数据。

<img src="https://liuyang-picbed.oss-cn-shanghai.aliyuncs.com/img/276a740d0eabf5f4be905fe7326d9fb3.jpg" alt="276a740d0eabf5f4be905fe7326d9fb3" style="zoom:33%;" />

ELF文件格式把各种信息，分成一个一个的section保存起来：

（1）**基本头文件（File Header）**，用来表示这个文件的基本属性，比如是否是可执行文件，对应的CPU、操作系统等。
（2）**代码段 .text section**，用来保存程序的代码和指令。
（3）**数据段 .data section**，用来保存程序里面设置好的初始化数据信息。
（4）**重定位表 .rel.text section**，重定位表里面保存的是当前的文件里面，哪些跳转地址是我们不知道的，比如调用了个printf或者自己写的add之类的函数，在链接发生之前，我们并不知道该跳转到那里。
（5）**符号表 .symtab section**，符号表保留了当前文件里面定义的函数名称和对应地址的地址簿。

**链接的主要流程：**

连接器会扫描所有输入的目标文件，然后把所有符号表里面的信息收集起来，构成一个全局的符号表。然后再根据重定位表，把所有不确定要跳转地址的代码，根据符号表里面存储的地址，进行一次修正。最后，把所有目标文件的对应段进行一次合并，变成了最终可以执行代码。

```
// add_lib.c
int add(int a, int b)
{
    return a+b;
}
```

```
// link_example.c
#include <stdio.h>
int main()
{
    int a = 10;
    int b = 5;
    int c = add(a, b);
    printf("c = %d\n", c);
}
```

生成目标文件，并查看汇编代码

```
$ gcc -g -c add_lib.c link_example.c
$ objdump -d -M intel -S add_lib.o
$ objdump -d -M intel -S link_example.o
```

链接生成可执行文件

```
$ gcc -o link-example add_lib.o link_example.o
$ ./link_example
c = 15
```

<img src="https://liuyang-picbed.oss-cn-shanghai.aliyuncs.com/img/f62da9b29aa53218f8907851df27f912.jpeg" alt="f62da9b29aa53218f8907851df27f912" style="zoom: 25%;" />

同样一个程序在linux下可以执行，而在windows下不醒，其中一个最主要的原因就是两个操作系统的可执行文件格式不一样，windows下的可执行文件是PE （Portable Executable Format）。如果我们有一个能够解析PE格式的装载器，我们就可以在linux下执行windows程序了，PS：linux开源项目Wine。同理windows也可以执行linux的程序，PS：WSL，windows subsystem for linux 可以解析和加载ELF格式文件。