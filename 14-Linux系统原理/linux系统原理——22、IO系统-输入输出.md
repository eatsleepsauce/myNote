#### 输入输出系统

计算机系统的输入和输出系统，例如键盘、鼠标、显示器、网卡、硬盘、打印机、CD/DVD 等等，多种多样。这样，当然方便用户使用了，但是对于操作系统来讲，却是一件复杂的事情，因为这么多设备，形状、用法、功能都不一样，怎么才能统一管理起来呢？

##### 一、用设备控制器屏蔽设备差异

CPU 并不直接和设备打交道，中间有一个叫作 **设备控制器（Device Control Unit）**的组件，例如硬盘有磁盘控制器、USB 有 USB 控制器、显示器有视频控制器等。这些控制器就像代理商一样，它们知道如何应对硬盘、鼠标、键盘、显示器的行为。

**控制器** 其实有点儿像一台小电脑。它有它的芯片，类似小 CPU，执行自己的逻辑。它也有它的寄存器。 **CPU 可以通过写这些寄存器，对控制器下发指令，通过读这些寄存器，查看控制器对于设备的操作状态。**

###### 1、设备分类

输入输出设备大致可以分为两类：**块设备（Block Device）**和 **字符设备（Character Device）**。

- 块设备将信息存储在固定大小的块中，每个块都有自己的地址。硬盘就是常见的块设备。
- 字符设备发送或接收的是字节流。而不用考虑任何块结构，没有办法寻址。鼠标就是常见的字符设备。

###### 2、CPU和控制器交互

由于块设备传输的数据量比较大，控制器里往往会有缓冲区。CPU 写入缓冲区的数据攒够一部分，才会发给设备。CPU 读取的数据，也需要在缓冲区攒够一部分，才拷贝到内存。

- 每个控制寄存器被分配一个 I/O 端口，通过特殊的汇编指令（例如 in/out 类似的指令）操作这些寄存器。
- 数据缓冲区，可内存映射 I/O，可以分配一段内存空间给它，就像读写内存一样读写数据缓冲区。

**控制器的寄存器一般会有状态标志位，可以通过检测状态标志位，来确定输入或者输出操作是否完成**。

- 第一种方式就是 **轮询等待**，就是一直查，一直查，直到完成。
- 第二种方式，就是可以通过 **中断的方式**，通知操作系统输入输出操作已经完成。

为了响应中断，一般会有一个硬件的中断控制器，**当设备完成任务后触发中断到中断控制器，中断控制器就通知 CPU，一个中断产生了，CPU 需要停下当前手里的事情来处理中断**。

中断有两种：

- 一种软中断，例如代码调用 INT 指令触发。
- 一种是硬件中断，就是硬件通过中断控制器触发的。

<img src="https://liuyang-picbed.oss-cn-shanghai.aliyuncs.com/img/5d9290f08847685d65bc3edd88242855.jpg" alt="5d9290f08847685d65bc3edd88242855" style="zoom:33%;" />

**DMA** ，有的设备需要读取或者写入大量数据。如果所有过程都让 CPU 协调的话，就需要占用 CPU 大量的时间，比方说，磁盘就是这样的。这种类型的设备需要支持 DMA 功能，实现 DMA 机制需要有个 DMA 控制器帮 CPU 来做协调。

CPU 只需要对 DMA 控制器下指令，说它想读取多少数据，放在内存的某个地方就可以了，接下来 DMA 控制器会发指令给磁盘控制器，读取磁盘上的数据到指定的内存位置，传输完毕之后，DMA 控制器发中断通知 CPU 指令完成，CPU 就可以直接用内存里面现成的数据了。

<img src="https://liuyang-picbed.oss-cn-shanghai.aliyuncs.com/img/1ef05750bc9ff87a3330104802965335.jpeg" alt="1ef05750bc9ff87a3330104802965335" style="zoom:33%;" />

##### 二、用驱动程序屏蔽设备控制器差异

由于每种设备的控制器的寄存器、缓冲区等使用模式，指令都不同，所以 **操作系统使用驱动程序来对接各个设备控制器**。

设备控制器不属于操作系统的一部分，但是设备驱动程序属于操作系统的一部分。操作系统的内核代码可以像调用本地代码一样调用驱动程序的代码，而驱动程序的代码需要发出特殊的面向设备控制器的指令，才能操作设备控制器。

设备驱动程序中是一些面向特殊设备控制器的代码。不同的设备不同。但是对于操作系统其它部分的代码而言，设备驱动程序应该有统一的接口。

<img src="https://liuyang-picbed.oss-cn-shanghai.aliyuncs.com/img/7bf96d3c8e3a82cdac9c7629b81fa368.png" alt="7bf96d3c8e3a82cdac9c7629b81fa368" style="zoom:33%;" />

设备做完了事情要 **通过中断来通知操作系统**。<u>操作系统需要有一个地方处理这个中断，既然设备驱动程序是用来对接设备控制器的，中断处理也应该在设备驱动里面完成。然而中断的触发最终会到达 CPU，会中断操作系统当前运行的程序，所以操作系统也要有一个统一的流程来处理中断，使得不同设备的中断使用统一的流程。</u>

**中断处理的一般的流程**：

- 一个设备驱动程序初始化的时候，要先注册一个该设备的中断处理函数。

- 中断返回的那一刻是进程切换的时机。中断的时候，触发的函数是 do_IRQ。这个函数是中断处理的统一入口。在这个函数里面，可以找到设备驱动程序注册的中断处理函数 Handler，然后执行它进行中断处理。

<img src="https://liuyang-picbed.oss-cn-shanghai.aliyuncs.com/img/aa9d074d9819f0eb513e11014a5772c0.jpg" alt="aa9d074d9819f0eb513e11014a5772c0" style="zoom:33%;" />

##### 三、用文件系统接口屏蔽驱动程序的差异

###### 1、通用块层

因为块设备类型非常多，而 Linux 操作系统里面一切是文件。文件系统以下，就直接对接各种各样的块设备驱动程序，会使得文件系统的复杂度非常高。所以，在中间加了一层通用块层，将与块设备相关的通用逻辑放在这一层，维护与设备无关的块的大小，然后 **通用块层下面对接各种各样的驱动程序**。

<img src="https://liuyang-picbed.oss-cn-shanghai.aliyuncs.com/img/3c506edf93b15341da3db658e9970773.jpg" alt="3c506edf93b15341da3db658e9970773" style="zoom:33%;" />

###### 2、文件系统接口

从硬件设备到设备控制器，到驱动程序，到通用块层，到文件系统，层层屏蔽不同的设备的差别，最终到这里操作设备，都可以基于文件系统的接口，**文件系统接口** 也要有一个统一的标准。

有了文件系统接口之后，不但可以通过文件系统的命令行操作设备，也可以通过程序，调用 read、write 函数，像读写文件一样操作设备。但是有些任务只使用读写很难完成，例如检查特定于设备的功能和属性，超出了通用文件系统的限制。所以，对于设备来讲，还有一种接口称为 ioctl，表示输入输出控制接口，是用于配置和修改特定设备属性的通用接口。



<img src="https://liuyang-picbed.oss-cn-shanghai.aliyuncs.com/img/80e152fe768e3cb4c84be62ad8d6d07f.jpg" alt="80e152fe768e3cb4c84be62ad8d6d07f" style="zoom:33%;" />

<img src="https://liuyang-picbed.oss-cn-shanghai.aliyuncs.com/img/3c473d163b6e90985d7301f115ab660e.jpeg" alt="3c473d163b6e90985d7301f115ab660e" style="zoom:33%;" />







**字符设备、块设备这些设备使用实现细节～～～后面补**

