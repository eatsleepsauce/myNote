#### 数据校验和恢复

##### 一、数据校验

**单比特翻转（Single-Bit Flip）**，内存里面的单比特翻转或者错误，并不是一个特别罕见的现象。无论是因为内存的制造质量造成的漏电，还是外部的射线，都有一定的概率，会造成单比特错误。

<img src="https://liuyang-picbed.oss-cn-shanghai.aliyuncs.com/img/45ad4eb91f48afd08c581148d5f6320f.jpeg" alt="45ad4eb91f48afd08c581148d5f6320f" style="zoom:33%;" />

**ECC 内存** 的全称是 Error-Correcting Code memory，中文名字叫作纠错内存。顾名思义，就是在内存里面出现错误的时候，能够自己纠正过来。

**奇偶校验和校验位**，奇偶校验的思路很简单。我们把内存里面的 N 位比特当成是一组。常见的，比如 8 位就是一个字节。然后，用额外的一位去记录，这 8 个比特里面有奇数个 1 还是偶数个 1。如果是奇数个 1，那额外的一位就记录为 1；如果是偶数个 1，那额外的一位就记录成 0。那额外的一位，我们就称之为**校验码位**。

<img src="https://liuyang-picbed.oss-cn-shanghai.aliyuncs.com/img/e94c642bdf41290d6a4e5eb2d6bb3c40.jpeg" alt="e94c642bdf41290d6a4e5eb2d6bb3c40" style="zoom:33%;" />

使用奇偶校验，还是有两个比较大的缺陷：

第一个缺陷，就是奇偶校验只能解决遇到单个位的错误，或者说奇数个位的错误。如果出现 2 个位进行了翻转，那么这个字节的校验位计算结果其实没有变，我们的校验位自然也就不能发现这个错误。

第二个缺陷，是它只能发现错误，但是不能纠正错误。



##### 二、纠错码以及海明码

###### 1、纠错码和海明码定义

**纠错码（Error Correcting Code）**，不仅能捕捉到错误，还要能够纠正发生的错误。它还有一个升级版本，叫作 **纠删码（Erasure Code）**，不仅能够纠正错误，还能够在错误不能纠正的时候，直接把数据删除。**无论是我们的 ECC 内存，还是网络传输，乃至硬盘的 RAID，其实都利用了纠错码和纠删码的相关技术**。

**最基础的海明码叫 7-4 海明码**。这里的“7”指的是实际有效的数据，一共是 7 位（Bit）。而这里的“4”，指的是我们额外存储了 4 位数据，用来纠错。

>纠错码的纠错能力是有限的。不是说不管错了多少位，我们都能给纠正过来。不然我们就不需要那 7 个数据位，只需要那 4 个校验位就好了，这意味着我们可以不用数据位就能传输信息了。这就不科学了。事实上，在 7-4 海明码里面，我们只能纠正某 1 位的错误。这是怎么做到的呢？我们一起来看看。

4 位的校验码，一共可以表示  2^4 = 16 个不同的数。根据数据位计算出来的校验值，一定是确定的。所以，如果数据位出错了，计算出来的校验码，一定和确定的那个校验码不同。那可能的值，就是在 2^4 - 1 = 15 那剩下的 15 个可能的校验值当中。15 个可能的校验值，其实可以对应 15 个可能出错的位。

既然我们的数据位只有 7 位，那为什么我们要用 4 位的校验码呢？用 3 位不就够了吗？2^3 - 1 = 7，正好能够对上 7 个不同的数据位啊！

单比特翻转的错误，不仅可能出现在数据位，也有可能出现在校验位。校验位本身也是可能出错的。所以，7 位数据位和 3 位校验位，如果只有单比特出错，可能出错的位数就是 10 位，2^3 - 1 = 7 种情况是不能帮我们找到具体是哪一位出错的。

**事实上，如果我们的数据位有 K 位，校验位有 N 位。那么我们需要满足下面这个不等式，才能确保我们能够对单比特翻转的数据纠错。这个不等式就是：K + N + 1 <= 2^N**

<img src="https://liuyang-picbed.oss-cn-shanghai.aliyuncs.com/img/ec8b6bff509e1abb7453caa36a4a711d-20210112223841846.jpeg" alt="ec8b6bff509e1abb7453caa36a4a711d" style="zoom:33%;" />

###### 2、海明码原理

为了算起来简单一点，来算一个 4-3 海明码（也就是 4 位数据位，3 位校验位）。把 4 位数据位，分别记作 d1、d2、d3、d4。我们把 3 位校验位，分别记作 p1、p2、p3。从 4 位的数据位里面，我们拿走 1 位，然后计算出一个对应的校验位。 **校验位的计算用奇偶校验 **就可以了。比如，我们用 d1、d2、d4 来计算出一个校验位 p1；用 d1、d3、d4 计算出一个校验位 p2；用 d2、d3、d4 计算出一个校验位 p3。就像下面这个对应的表格一样：

<img src="https://liuyang-picbed.oss-cn-shanghai.aliyuncs.com/img/6d7cf44bb41df6361e82dcd4979dc4bc.jpeg" alt="6d7cf44bb41df6361e82dcd4979dc4bc" style="zoom:33%;" />

如果 d1 这一位的数据出错了，会发生什么情况？我们会发现，p1 和 p2 和校验的计算结果不一样。

d2 出错了， p1 和 p3 的校验的计算结果不一样；

d3 出错了，则是p2 和 p3；

如果 d4 出错了，则是 p1、p2、p3 都不一样。

当数据码出错的时候，至少会有 2 位校验码的计算是不一致的。

那我们倒过来，如果是 p1 的校验码出错了，会发生什么情况呢？这个时候，只有 p1 的校验结果出错。p2 和 p3 的出错的结果也是一样的，只有一个校验码的计算是不一致的。所以校验码不一致，一共有 2^3-1=7 种情况，正好对应了 7 个不同的位数的错误。

<img src="https://liuyang-picbed.oss-cn-shanghai.aliyuncs.com/img/3edee00788294bb96cde11dace2a7721.jpeg" alt="3edee00788294bb96cde11dace2a7721" style="zoom:33%;" />

**海明码这样的纠错过程，有点儿像电影里面看到的推理探案的过程。通过出错现场的额外信息，一步一步条分缕析地找出，到底是哪一位的数据出错，还原出错时候的“犯罪现场”。**

###### 3、规则化生成海明码

首先，我们先确定编码后，要传输的数据是多少位。比如说，我们这里的 7-4 海明码，就是一共 11 位。

然后，我们给这 11 位数据从左到右进行编号，并且也把它们的二进制表示写出来。

接着，我们先把这 11 个数据中的二进制的整数次幂找出来。在这个 7-4 海明码里面，就是 1、2、4、8。这些数，就是我们的校验码位，我们把他们记录做 p1～p4。如果从二进制的角度看，它们是这 11 个数当中，唯四的，在 4 个比特里面只有一个比特是 1 的数值。

那么剩下的 7 个数，就是我们 d1-d7 的数据码位了。

然后，对于我们的校验码位，我们还是 **用奇偶校验码**。但是每一个校验码位，不是用所有的 7 位数据来计算校验码。而是 p1 用 3、5、7、9、11 来计算。也就是，在二进制表示下，从右往左数的第一位比特是 1 的情况下，用 p1 作为校验码。剩下的 p2，我们用 3、6、10、11 来计算校验码，也就是在二进制表示下，从右往左数的第二位比特是 1 的情况下，用 p2。那么，p3 自然是从右往左数，第三位比特是 1 的情况下的数字校验码。而 p4 则是第四位比特是 1 的情况下的校验码。

<img src="https://liuyang-picbed.oss-cn-shanghai.aliyuncs.com/img/a7d5e958f9d46938e494710e090f469d.jpeg" alt="a7d5e958f9d46938e494710e090f469d" style="zoom:33%;" />

任何一个数据码出错了，就至少会有对应的两个或者三个校验码对不上，这样我们就能反过来找到是哪一个数据码出错了。如果校验码出错了，那么只有校验码这一位对不上，我们就知道是这个校验码出错了。

###### 4、海明距离

**对于两个二进制表示的数据，他们之间有差异的位数，我们称之为海明距离**。比如 1001 和 0001 的海明距离是 1，因为他们只有最左侧的第一位是不同的。而 1001 和 0000 的海明距离是 2，因为他们最左侧和最右侧有两位是不同的。

<img src="https://liuyang-picbed.oss-cn-shanghai.aliyuncs.com/img/fb388f965a7a7631925a32cc4610ff78.jpeg" alt="fb388f965a7a7631925a32cc4610ff78" style="zoom:33%;" />

所谓的进行一位纠错，也就是所有和我们要传输的数据的海明距离为 1 的数，都能被纠正回来。而任何两个实际我们想要传输的数据，海明距离都至少要是 3，为什么不能是 2 呢？因为如果是 2 的话，那么就会有一个出错的数，到两个正确的数据的海明距离都是 1。当我们看到这个出错的数的时候，我们就不知道究竟应该纠正到那一个数了。



无论是我们的 ECC 内存，还是网络传输，乃至硬盘的 RAID，其实都利用了纠错码和纠删码的相关技术。



读一读《计算机组成与设计：软件 / 硬件接口》的 5.5 章节，关于可信存储器的部分。