#### 虚拟机和Docker

虚拟机技术，使得我们可以在一台物理服务器上，同时运行多个虚拟服务器，并且可以动态去分配，每个虚拟服务器占用的资源。对于不运行的虚拟服务器，我们也可以把这个虚拟服务器“关闭”。这个“关闭”了的服务器，就和一个被关掉的物理服务器一样，它不会再占用实际的服务器资源。但是，当我们重新打开这个虚拟服务器的时候，里面的数据和应用都在，不需要再重新安装一次。

##### 一、虚拟机的技术变迁

###### 1、早期虚拟机——模拟器

**虚拟机**（Virtual Machine）技术，其实就是指在现有硬件的操作系统上，能够模拟一个计算机系统的技术。而模拟一个计算机系统，最简单的办法，其实不能算是虚拟机技术，而是一个 **模拟器**（Emulator）。

我们把原先的操作系统叫作 **宿主机（Host）**，把能够有能力去模拟指令执行的软件，叫作 **模拟器（Emulator）**，而实际运行在模拟器上被“虚拟”出来的系统呢，我们叫 **客户机（Guest VM）**。

**模拟器这种解释执行方式的最大的优势就是，模拟的系统可以跨硬件。**不过这个方式也有两个明显的缺陷：

（1）做不到精确的“模拟”。很多的老旧的硬件的程序运行，要依赖特定的电路乃至电路特有的时钟频率，想要通过软件达到 100% 模拟是很难做到的。

（2）解释执行的方式，性能实在太差了。因为我们并不是直接把指令交给 CPU 去执行的，而是要经过各种解释和翻译工作。

###### 2、Type-1 和 Type-2

我们希望我们的虚拟化技术，能够克服上面的模拟器方式的两个缺陷。同时，我们可以放弃掉模拟器方式能做到的跨硬件平台的这个能力。因为毕竟对于我们想要做的云服务里的“服务器租赁”业务来说，中小客户想要租的也是一个 x86 的服务器。而另外一方面，他们希望这个租用的服务器用起来，和直接买一台或者租一台物理服务器没有区别。

所以，首先我们需要一个“全虚拟化”的技术，也就是说，可以在现有的物理服务器的硬件和操作系统上，去跑一个完整的、不需要做任何修改的客户机操作系统（Guest OS）—— 解决方案就是加入一个中间层。在虚拟机技术里面，这个中间层就叫作 **虚拟机监视器**，英文叫 VMM（Virtual Machine Manager）或者 **Hypervisor**。

**目前使用的虚拟机分为两种：Type-1 和 Type-2**

（1）Type-2

Type-2 类型的虚拟机。在 Type-2 虚拟机里，虚拟机监视器好像一个运行在操作系统上的软件。客户机的操作系统呢，把最终到硬件的所有指令，都发送给虚拟机监视器。而虚拟机监视器，又会把这些指令再交给宿主机的操作系统去执行。这和上面的模拟器看起来没有那么大分别，看起来，我们 **只是把在模拟器里的指令翻译工作，挪到了虚拟机监视器里**。

**因此，Type-2 型的虚拟机，更多是用在我们日常的个人电脑里，而不是用在数据中心里**。

（2）Type-1

**Type-1 型的虚拟机，客户机的指令交给虚拟机监视器之后，不再需要通过宿主机的操作系统，才能调用硬件，而是可以直接由虚拟机监视器去调用硬件。**另外，在数据中心里面，我们并不需要在 Intel x86 上面去跑一个 ARM 的程序，而是直接在 x86 上虚拟一个 x86 硬件的计算机和操作系统。所以，我们的指令不需要做什么翻译工作，可以直接往下传递执行就好了，所以指令的执行效率也会很高。

在 Type-1 型的虚拟机里，我们的虚拟机监视器其实并不是一个操作系统之上的应用层程序，而是一个嵌入在操作系统内核里面的一部分。无论是 KVM、XEN 还是微软自家的 Hyper-V，其实都是系统级的程序。

<img src="https://liuyang-picbed.oss-cn-shanghai.aliyuncs.com/img/9c30f8d93270a9563154aa732b9c9f8e.jpeg" alt="9c30f8d93270a9563154aa732b9c9f8e" style="zoom:25%;" />

因为虚拟机监视器需要直接和硬件打交道，所以它也需要包含能够直接操作硬件的驱动程序。所以 Type-1 的虚拟机监视器更大一些，同时兼容性也不能像 Type-2 型那么好。

##### 二、Docker

Type-1 型的虚拟机看起来已经没有什么硬件损耗。但是，这里面还是有一个浪费的资源。在我们实际的物理机上，我们可能同时运行了多个的虚拟机，而这每一个虚拟机，都运行了一个属于自己的单独的操作系统。

**多运行一个操作系统，意味着我们要多消耗一些资源在 CPU、内存乃至磁盘空间上**。

其实我们想要的未必是一个完整的、独立的、全虚拟化的虚拟机。我们很多时候想要租用的不是“独立服务器”，而是独立的计算资源。在服务器领域，我们开发的程序都是跑在 Linux 上的。**其实我们并不需要一个独立的操作系统，只要一个能够进行资源和环境隔离的“独立空间”就好了**。那么，能够满足这个需求的解决方案，就是过去几年特别火热的 Docker 技术。

<img src="https://liuyang-picbed.oss-cn-shanghai.aliyuncs.com/img/6cbf5f5f4275bc053fabcd3480304a35.jpeg" alt="6cbf5f5f4275bc053fabcd3480304a35" style="zoom:25%;" />

在实践的服务器端的开发中，虽然我们的应用环境需要各种各样不同的依赖，可能是不同的 PHP 或者 Python 的版本，可能是操作系统里面不同的系统库，但是通常来说，我们其实都是跑在 Linux 内核上的。通过 Docker，我们不再需要在操作系统上再跑一个操作系统，而只需要通过容器编排工具，比如 Kubernetes 或者 Docker Swarm，能够进行各个应用之间的环境和资源隔离就好了。这种隔离资源的方式呢，也有人称之为“操作系统级虚拟机”，不过严格来说，**Docker 并不能算是一种虚拟机技术，而只能算是一种资源隔离的技术而已。**

