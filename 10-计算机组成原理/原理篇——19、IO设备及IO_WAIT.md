#### IO设备及IO_WAIT

##### 一、接口和设备

输入输出设备，并不只是一个设备。大部分的输入输出设备，都有两个组成部分：

（1）**第一个是它的接口（Interface）**。

（2）**第二个才是实际的 I/O 设备（Actual I/O Device）**。

硬件设备并不是直接接入到总线上和 CPU 通信的，而是通过接口，用接口连接到总线上，再通过总线和 CPU 通信。

**并行接口（Parallel Interface）**、**串行接口（Serial Interface）**、**USB 接口**，都是计算机主板上内置的各个接口。

**设备里面有三类寄存器，其实都在这个设备的接口电路上，而不在实际的设备上**。这三类寄存器它们分别是 **状态寄存器（Status Register）**、 **命令寄存器（Command Register）**以及 **数据寄存器（Data Register）**。

**除了内置在主板上的接口之外，有些接口可以集成在设备上。**

把接口和实际设备分离，这个做法实际上来自于计算机走向开放架构（Open Architecture）的时代。

##### 二、CPU是如何控制I/O设备的

首先，在 I/O 设备这一侧，我们把 I/O 设备拆分成，能和 CPU 通信的接口电路，以及实际的 I/O 设备本身。接口电路里面有对应的状态寄存器、命令寄存器、数据寄存器、数据缓冲区和设备内存等等。接口电路通过总线和 CPU 通信，接收来自 CPU 的指令和数据。而接口电路中的控制电路，再解码接收到的指令，实际去操作对应的硬件设备。

而在 CPU 这一侧，对 CPU 来说，它看到的并不是一个个特定的设备，而是一个个内存地址或者端口地址。CPU 只是向这些地址传输数据或者读取数据。所需要的指令和操作内存地址的指令其实没有什么本质差别。

###### 1、控制电路

无论是内置在主板上的接口，还是集成在设备上的接口，除了三类寄存器之外，还有对应的控制电路。正是通过这个控制电路，CPU 才能通过向这个接口电路板传输信号，来控制实际的硬件。

<img src="https://liuyang-picbed.oss-cn-shanghai.aliyuncs.com/img/fd788de17028e8b1dbce58de5da31e38.jpeg" alt="fd788de17028e8b1dbce58de5da31e38" style="zoom: 33%;" />

打印机作为例子：

（1）首先是数据寄存器（Data Register）。CPU 向 I/O 设备写入需要传输的数据。

（2）然后是命令寄存器（Command Register）。CPU 发送一个命令，告诉打印机，要进行打印工作。这个时候，打印机里面的控制电路会做两个动作。第一个，是去设置我们的状态寄存器里面的状态，把状态设置成 not-ready。第二个，就是实际操作打印机进行打印。

（3）状态寄存器（Status Register），就是告诉了CPU，现在设备已经在工作了，所以这个时候，CPU 再发送数据或者命令过来，都是没有用的。直到前面的动作已经完成，状态寄存器重新变成了 ready 状态。

###### 2、通信

CPU 和 I/O 设备的通信，一样是通过 CPU 支持的机器指令来执行的。

（1）内存映射MMIO

**内存映射IO（Memory-Mapped I/O，简称 MMIO）**，计算机会把 I/O 设备的各个寄存器，以及 I/O 设备内部的内存地址，都映射到主内存地址空间里来。主内存的地址空间里，会给不同的 I/O 设备预留一段一段的内存地址。CPU 想要和这些 I/O 设备通信的时候呢，就往这些地址发送数据。这些地址信息，就是通过地址线来发送的，而对应的数据信息呢，就是通过数据线来发送的了。

I/O 设备会监控地址线，并且在 CPU 往自己地址发送数据的时候，把对应的数据线里面传输过来的数据，接入到对应的设备里面的寄存器和内存里面来。CPU 无论是向 I/O 设备发送命令、查询状态还是传输数据，都可以通过这样的方式。

<img src="https://liuyang-picbed.oss-cn-shanghai.aliyuncs.com/img/bb8c1c007f7263bee41b7c649304c722.jpeg" alt="bb8c1c007f7263bee41b7c649304c722" style="zoom: 33%;" />

（2）端口映射 I/O PMIO

**持端口映射 I/O（Port-Mapped I/O，简称 PMIO**）或者也可以叫独立输入输出（Isolated I/O），PMIO 的通信方式和 MMIO 差不多，核心的区别在于，PMIO 里面访问的设备地址，不再是在内存地址空间里面，而是一个专门的端口（Port）。这个端口并不是指一个硬件上的插口，而是和 CPU 通信的一个抽象概念。

##### 三、IO性能、顺序访问和随机访问

在顺序读取的情况下，无论是 HDD 硬盘还是 SSD 硬盘，性能看起来都是很不错的。不过，等到进行随机读取测试的时候，硬盘的性能才能见了真章。因为在大部分的应用开发场景下，我们关心的并不是在顺序读写下的数据量，而是 **每秒钟能够进行输入输出的操作次数，也就是 IOPS** 。

即使是使用 PCI Express 接口的 SSD 硬盘，IOPS 也就只是到了 2 万左右。这个性能，和我们 CPU 的每秒 20 亿次操作的能力比起来，可就差得远了。所以很多时候，**我们的程序对外响应慢，其实都是 CPU 在等待 I/O 操作完成**。

在 Linux 下，我们可以通过 top 这样的命令，来看整个服务器的整体负载。在应用响应慢的时候，我们可以先通过这个指令，来看 CPU 是否在等待 I/O 完成自己的操作。进一步地，我们可以通过 iostat 这个命令，来看到各个硬盘这个时候的读写情况。而 iotop 这个命令，能够帮助我们定位到到底是哪一个进程在进行大量的 I/O 操作。



了解 CPU 和 I/O 设备交互的技术细节，看一看北京大学在 Coursera 上的视频课程，《计算机组成》第 10 周的内容。

关于 IO_WAIT 的文章，在互联网上已经有不少了。可以读一读这一篇Understanding IOPS Latency and Storage Performance   https://louwrentius.com/understanding-iops-latency-and-storage-performance.html，进一步理解一下什么是 IOPS 和 IO_WAIT。

