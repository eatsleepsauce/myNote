#### 认识故障

对于分布式系统的容错设计，在英文中又叫 Resiliency（弹力）。意思是，系统在不健康、不顺，甚至出错的情况下有能力 hold 得住，挺得住，还有能在这种逆境下力挽狂澜的能力。

##### 一、系统可用性测量

一个工业界里使用的一个公式：

Availability = MTTF / (MTTF+MTTR)

- MTTF 是 Mean Time To Failure，平均故障前的时间，即系统平均能够正常运行多长时间才发生一次故障。系统的可靠性越高，MTTF 越长。（注意：从字面上来说，看上去有 Failure 的字样，但其实是正常运行的时间。）

- MTTR 是 Mean Time To Recovery，平均修复时间，即从故障出现到故障修复的这段时间，这段时间越短越好。

这个公式就是计算系统可用性的，也就是我们常说的，多少个 9，如下表所示。

![img](https://liuyang-picbed.oss-cn-shanghai.aliyuncs.com/img/c3ac18852cc1067b3d7df4223a340372.png)

##### 二、故障原因

我们很难计算我们设计的系统有多少的可用性，因为影响一个系统的因素实在是太多了，除了软件设计，还有硬件，还有第三方服务（如电信联通的宽带 SLA），当然包括“建筑施工队的挖掘机”。

工业界中，会把服务不可用的因素分成两种：一种是有计划的，一种是无计划的。

###### 1、无计划的

<img src="https://liuyang-picbed.oss-cn-shanghai.aliyuncs.com/img/a879f083b84e956e3b3ab549fac18a0b.jpg" alt="img" style="zoom: 25%;" />

- **系统级故障**，包括主机、操作系统、中间件、数据库、网络、电源以及外围设备。
- **数据和中介的故障**，包括人员误操作、硬盘故障、数据乱了。
- 还有自然灾害、人为破坏，以及供电问题等。

###### 2、有计划的

<img src="https://liuyang-picbed.oss-cn-shanghai.aliyuncs.com/img/3b17a354d64de88e8a51c381b64401ad.jpg" alt="img" style="zoom:25%;" />

- **日常任务**：备份，容量规划，用户和安全管理，后台批处理应用。
- **运维相关**：数据库维护、应用维护、中间件维护、操作系统维护、网络维护。
- **升级相关**：数据库、应用、中间件、操作系统、网络，包括硬件升级。

###### 3、故障原因归类

1. **网络问题**，网络链接出现问题，网络带宽出现拥塞……
2. **性能问题**，数据库慢 SQL、Java Full GC、硬盘 IO 过大、CPU 飙高、内存不足……
3. **安全问题**，被网络攻击，如 DDoS 等。
4. **运维问题**，系统总是在被更新和修改，架构也在不断地被调整，监控问题……
5. **管理问题**，没有梳理出关键服务以及服务的依赖关系，运行信息没有和控制系统同步……
6. **硬件问题**，硬盘损坏、网卡出问题、交换机出问题、机房掉电、挖掘机问题……

##### 三、故障不可以避免

故障是正常的，而且是常见的。故障是不可预测突发的，而且相当难缠。

**不要尝试着去避免故障，而是要把处理故障的代码当成正常的功能做在架构里写在代码里。**



