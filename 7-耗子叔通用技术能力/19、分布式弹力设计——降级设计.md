#### 降级设计 degradation

降级设计（Degradation），本质是为了解决资源不足和访问量过大的问题。当资源和访问量出现矛盾的时候，在有限的资源下，为了能够扛住大量的请求，我们就需要对系统进行降级操作。也就是说，暂时牺牲掉一些东西，以保障整个系统的平稳运行。

降级需要牺牲掉的东西有：

- **降低一致性**，从强一致性变成最终一致性。
- **停止次要功能**，停止访问不重要的功能，从而释放出更多的资源。
- **简化功能**，把一些功能简化掉，比如，简化业务流程，或是不再返回全量数据，只返回部分数据。

##### 一、降低一致性

大多数系统并不是都需要强一致性的。对于降低一致性，把强一致性变成最终一致性的做法可以有效地释放资源，并且让系统运行得更快，从而可以扛住更大的流量。一般来说，会有两种做法，一种是简化流程的一致性，一种是降低数据的一致性。

###### 1、使用异步简化流程

<img src="https://liuyang-picbed.oss-cn-shanghai.aliyuncs.com/img/2c8ea19d132f2efb333ea9e741ea8543.png" alt="2c8ea19d132f2efb333ea9e741ea8543" style="zoom: 67%;" />

###### 2、降低数据的一致性

降低数据的一致性一般来说会使用缓存的方式，或是直接就去掉数据。比如，在页面上不显示库存的具体数字，只显示有还是没有库存这两种状态。

对于降级后的系统，不再通过数据库获取数据，而是通过缓存获取数据。在功能降级中，我们一般使用 Cache Aside 模式或是 Read Through 模式。也就是下图所示的这个策略。

<img src="https://liuyang-picbed.oss-cn-shanghai.aliyuncs.com/img/bdf7522a231ec2c1136a70f07db0c5c4.png" alt="bdf7522a231ec2c1136a70f07db0c5c4" style="zoom:67%;" />

- **失效**：应用程序先从 cache 取数据，如果没有得到，则从数据库中取数据，成功后，放到缓存中。
- **命中**：应用程序从 cache 中取数据，取到后返回。
- **更新**：先把数据存到数据库中，成功后，再让缓存失效。

Read Through 模式就是在查询操作中更新缓存，也就是说，当缓存失效的时候（过期或 LRU 换出），Cache Aside 是由 **调用方负责把数据加载到缓存**，而 Read Through 则用 **缓存服务自己来加载**，从而对应用方是透明的。

##### 二、停止次要的功能

停止次要的功能也是一种非常有用的策略。把一些不重要的功能给暂时停止掉，让系统释放出更多的资源来。

当然，最好不要停止次要的功能，首先可以限制次要的功能的流量，或是把次要的功能退化成简单的功能，最后如果量太大了，才会进入停止功能的状态。

##### 三、简化功能

上面的下单流程中已经提到过相应的例子了。而且，从缓存中返回数据也是其中一个。这里再提一个，就是一般来说，一个 API 会有两个版本，一个版本返回全量数据，另一个版本只返回部分或最小的可用的数据。

##### 四、降级设计的要点

1. 一般来说是要牺牲业务功能或是流程，以及一致性的。所以，我们需要对业务做非常仔细的梳理和分析。我们很难通过不侵入业务的方式来做到功能降级。
2. 需要清楚地定义好降级的关键条件，比如，吞吐量过大、响应时间过慢、失败次数多过，有网络或是服务故障，等等，然后做好相应的应急预案。预案最好是写成代码可以快速地自动化或半自动化执行的。
3. 功能降级需要梳理业务的功能，哪些是 must-have 的功能，哪些是 nice-to-have 的功能；哪些是必须要死保的功能，哪些是可以牺牲的功能。
4. 降级的时候，需要牺牲掉一致性，或是一些业务流程：对于读操作来说，使用缓存来解决，对于写操作来说，需要异步调用来解决。并且，我们需要以流水账的方式记录下来，这样方便对账，以免漏掉或是和正常的流程混淆。
5. 降级的功能的开关可以是一个系统的配置开关。
6. 对于数据方面的降级，需要前端程序的配合。
7. 降级的功能平时不会总是会发生，需要在平时做一些演练。