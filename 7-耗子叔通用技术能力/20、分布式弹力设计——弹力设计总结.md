#### 弹力设计总结

##### 一、弹力设计总图

###### 1、服务冗余

服务不能是单点，所以，我们需要在架构中冗余服务，也就是说有多个服务的副本。这需要使用到的具体技术有：

- 负载均衡 + 服务健康检查–可以使用像 Nginx 或 HAProxy 这样的技术；
- 服务发现 + 动态路由 + 服务健康检查，比如 Consul 或 ZooKeeper；
- 自动化运维，Kubernetes 服务调度、伸缩和故障迁移。

###### 2、服务解耦

要隔离我们的服务我们就需要对服务进行解耦和拆分，需要使用到的相关技术：

- bulkheads 模式：业务分片 、用户分片、数据库拆分。
- 自包含系统：所谓自包含的系统是从单体到微服务的中间状态，其把一组密切相关的微服务给拆分出来，只需要做到没有外部依赖就行。
- 异步通讯：服务发现、事件驱动、消息队列、业务工作流。
- 自动化运维：需要一个服务调用链和性能监控的监控系统。

###### 3、服务容错

让整个架构接受失败的相关处理设计，也就是所谓的容错设计。这会用到下面的这些技术：

- 错误方面：调用重试 + 熔断 + 服务的幂等性设计。
- 一致性方面：强一致性使用两阶段提交、最终一致性使用异步通讯方式。
- 流控方面：使用限流 + 降级技术。
- 自动化运维方面：网关流量调度，服务监控。

<img src="https://liuyang-picbed.oss-cn-shanghai.aliyuncs.com/img/f9e6efa6202103a14d358ff6c80f0a2b.png" alt="f9e6efa6202103a14d358ff6c80f0a2b" style="zoom:67%;" />

- 冗余服务。通过冗余服务的复本数可以消除单点故障。这需要服务发现，负载均衡，动态路由和健康检查四个功能或组件。

- 服务解耦。通过解耦可以做到把业务隔离开来，不让服务间受影响，这样就可以有更好的稳定性。

  在水平层面上，需要把业务或用户分片分区（业分做隔离，用户做多租户）。

  在垂直层面上，需要异步通讯机制。

  因为应用被分解成了一个一个的服务，所以在服务的编排和聚合上，需要有工作流（像 Spring 的 Stream 或 Akka 的 flow 或是 AWS 的 Simple Workflow）来把服务给串联起来。而一致性的问题又需要业务补偿机制来做反向交易。

- 服务容错。服务容错方面，需要有重试机制，重试机制会带来幂等操作，对于服务保护来说，熔断，限流，降级都是为了保护整个系统的稳定性，并在可用性和一致性方面在出错的情况下做一部分的妥协。

  当然，还需要一个或多个 **自动运维的工具**，否则，如果是人肉运维的话，那么在故障发生的时候，不能及时地做出运维决定，也就空有这些弹力设计了。比如：监控到服务性能不够了，就自动或半自动地开始进行限流或降级。

##### 二、弹力设计开发和运维

对于运维工具来说，至少需要两个系统：

- 一个是像 APM 这样的服务监控
- 另一个是服务调度的系统，如：Docker + Kubernetes。

**如果需要一个开发架构来让整个开发团队在同一个标准下开发上面的这些东西，Spring Cloud 就是不二之选了。**

Spring Cloud 和 Kubernetes，它们都是为了微服务而生，但它们没有什么可比性，因为，前者偏开发，后者偏运维。

![35cd0722f99f91c904944ac1bbdd56f4](https://liuyang-picbed.oss-cn-shanghai.aliyuncs.com/img/35cd0722f99f91c904944ac1bbdd56f4-20210413222536853.png)

（图片来自：Deploying Microservices: Spring Cloud vs Kubernetes）

- Spring Cloud 有一套丰富且集成良好的 Java 库，作为应用栈的一部分解决所有运行时问题。因此，微服务本身可以通过库和运行时代理解决客户端服务发现、负载均衡、配置更新、统计跟踪等。工作模式就像单实例服务集群。（译者注：集群中 master 节点工作：当 master 挂掉后，slave 节点被选举顶替。）并且一批工作也是在 JVM 中被管理。
- Kubernetes **不是针对语言的，而是针对容器的**，所以，它是以通用的方式为所有语言解决分布式计算问题。Kubernetes 提供了配置管理、服务发现、负载均衡、跟踪、统计、单实例、平台级和应用栈之外的调度工作。该应用不需要任何客户端逻辑的库或代理程序，可以用任何语言编写。

<img src="https://liuyang-picbed.oss-cn-shanghai.aliyuncs.com/img/dcab89f031d1a7083b4f0b3091873caf.png" alt="dcab89f031d1a7083b4f0b3091873caf" style="zoom:80%;" />

两个平台依靠相似的第三方工具，如 ELK 和 EFK stacks, tracing libraries 等。Hystrix 和 Spring Boot 等库，在两个环境中都表现良好。很多情况下，Spring Cloud 和 Kubernetes 可以形成互补，组建出更强大的解决方案（例如 KubeFlix 和 Spring Cloud Kubernetes）。

下图是在 Kubernetes 上使用 Spring Cloud 可以表现出来的整体特性。其中红色的是运维层面的和 Spring Cloud 和 Kubernetes 不相关的，绿色的 Spring Cloud 提供的开发框架，蓝色的是 Kubernetes 相关的重要功能。

![41e9f7a084e6c81fcb3bb42d43b0076a](https://liuyang-picbed.oss-cn-shanghai.aliyuncs.com/img/41e9f7a084e6c81fcb3bb42d43b0076a.png)

