#### 隔离设计 Bulkheads

隔离设计对应的单词是 Bulkheads，中文翻译为隔板。这个术语是用在造船上的，也就是船舱里防漏水的隔板。一般的船无论大小都会有这个东西，大一点的船都会把船舱隔成若干个空间。这样，如果船舱漏水，只会进到一个小空间里，不会让整个船舱都进水而导致整艘船都沉了。

在分布式软件架构中，同样需要使用类似的技术来让我们的故障得到隔离。这就需要我们对系统进行分离。一般来说，对于系统的分离有两种方式，一种是 **以服务的种类来做分离**，一种是 **以用户来做分离**。

##### 一、按服务的种类来做分离

<img src="https://liuyang-picbed.oss-cn-shanghai.aliyuncs.com/img/34e3b94399f89a825a0046234607f9eb.png" alt="img" style="zoom: 67%;" />

上图中，将系统分成了用户、商品、社区三个板块。这三个块分别使用不同的域名、服务器和数据库，做到从接入层到应用层再到数据层三层完全隔离。这样一来，在物理上来说，一个板块的故障就不会影响到另一板块。

然而任何架构都有其好和不好的地方，上面这种架构虽然在系统隔离上做得比较好，但是也存在以下一些问题。

- 如果需要同时获得多个板块的数据，那么就需要调用多个服务，这会降低性能（实时）。

  对于这样的问题，一般来说，我们需要小心地设计用户交互，最好不要让用户在一个页面上获得所有的数据。

- 如果有大数据平台，就需要把这些数据都抽取到一个数据仓库中进行计算，这也增加了数据合并的复杂度。

  对于这个问题，我们需要一个框架或是一个中间件来对数据进行相应的抽取。

- 如果业务逻辑或是业务流程需要跨板块的话，那么一个板块的故障也会导致整个流程走不下去，同样会导致整体业务故障。

  对于这个问题，一方面，我们需要保证这个业务流程中各个子系统的高可用性，并且在业务流程上做成 Step-by-Step 的方式，这样用户交互的每一步都可以保存，以便故障恢复后可以继续执行，而不是从头执行。

- 如果需要有跨板块的交互也会变得有点复杂。

  对此我们需要一个类似于 Pub/Sub 的高可用、且可以持久化的消息订阅通知中间件来打通各个板块的数据和信息交换。

- 会有在多个板块中分布式事务的问题。

  对此，我们需要“二阶段提交”这样的方案。在亚马逊中，使用的是 Plan – Reserve – Commit/Cancel 模式。

##### 二、按用户的请求来做分离

<img src="https://liuyang-picbed.oss-cn-shanghai.aliyuncs.com/img/a7293c5fe813a7e8e2498aac34c4825e.png" alt="img" style="zoom: 50%;" />

上图中将用户分成不同的组，并把后端的同一个服务根据这些不同的组分成不同的实例。让同一个服务对于不同的用户进行冗余和隔离，这样一来，当服务实例挂掉时，只会影响其中一部分用户，而不会导致所有的用户无法访问。

这种分离和上面按功能的分离可以融合。说白了，这就是所谓的“多租户”模式。对于一些比较大的客户，我们可以为他们设置专门独立的服务实例，或是服务集群与其他客户隔离开来，对于一些比较小的用户来说，可以让他们共享一个服务实例，这样可以节省相关的资源。

对于“多租户”的架构来说，会引入一些系统设计的复杂度。一方面，如果完全隔离，资源使用上会比较浪费，如果共享，又会导致程序设计的一些复杂度。

通常来说多租户的做法有三种：

1. **完全独立的设计**，每个租户有自己完全独立的服务和数据。
2. **独立的数据分区**，共享的服务。多租户的服务是共享的，但数据是分开隔离的。
3. **共享的服务**，共享的数据分区。每个租户的数据和服务都是共享的。

<img src="https://liuyang-picbed.oss-cn-shanghai.aliyuncs.com/img/0c7cb0d25fb2c65a8db011ba61b8729c.png" alt="img" style="zoom: 50%;" />

一般来说，技术方案会使用折衷方案，也就是中间方案，服务是共享的，数据通过分区来隔离，而对于一些比较重要的租户（需要好的隔离性），则使用完全独立的方式。然而，在虚拟化技术非常成熟的今天，我们完全可以使用“完全独立”（完全隔离）的方案，通过底层的虚拟化技术（Hypervisor 的技术，如 KVM，或是 Linux Container 的技术，如 Docker）来实现物理资源的共享和成本的节约。

##### 三、隔离设计的重点

1. 需要定义好隔离业务的大小和粒度，过大和过小都不好。这需要认真地做业务上的需求和系统分析。
2. 无论是做系统板块还是多租户的隔离，你都需要考虑系统的复杂度、成本、性能、资源使用的问题，找到一个合适的均衡方案。
3. 隔离模式需要配置一些高可用、重试、异步、消息中间件，流控、熔断等设计模式的方式配套使用。
4. 需要很多自动化运维的工具，尤其是使用像容器或是虚拟机这样的虚拟化技术可以帮助我们更方便地管理，和对比资源更好地利用。
5. 需要一个非常完整的能够看得到所有服务的监控系统。

