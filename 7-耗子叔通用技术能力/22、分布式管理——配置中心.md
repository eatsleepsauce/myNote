#### 配置中心 Configuration Management

##### 一、为什么需要配置中心

软件的配置信息，比如数据库的用户名和密码，还有一些我们不想写死在代码里的东西，像线程池大小、队列长度等运行参数，以及日志级别、算法策略等，还有一些是软件运行环境的参数，如 Java 的内存大小，应用启动的参数，包括操作系统的一些参数配置……

以前，我们把软件配置写在一个配置文件中，就像 Windows 下的 ini 文件，或是 Linux 下的 conf 文件。然而，在分布式系统下，这样的方式就变得非常不好管理，并容易出错。于是，为了便于管理，我们引入了一个集中式的配置管理系统，这就是配置中心的由来。

##### 二、区分软件的配置

有一种方式是把软件的配置分成 **静态配置** 和 **动态配置**。

**静态配置** 其实就是在软件启动时的一些配置，运行时基本不会进行修改，也可以理解为是环境或软件初始化时需要用到的配置。例如，操作系统的网络配置，软件运行时 Docker 进程的配置，这些配置在软件环境初始化时就确定了，未来基本不会修改了。

**动态配置** 其实就是软件运行时的一些配置，在运行时会被修改。比如，日志级别、降级开关、活动开关。

**配置中心主要针对动态配置的管理**，动态配置的管理一般来说有三个区分维度：

- **按运行环境区分**，一般来说，会有开发环境、测试环境、预发环境、生产环境。这些环境上的运行配置都不完全一样，但是理论来说，应该是大同小异的。
- **按依赖区分**，一种是 **依赖配置**，一种是 **不依赖的内部配置**。比如，外部依赖的 MySQL 或 Redis 的连接配置。还有一种完全是自己内部的配置。
- **按层次区分**，配置也可以分成 IaaS、PaaS、SaaS 三层。基础层的配置是操作系统的配置，中间平台层的配置是中间件的配置，如 Tomcat 的配置，上层软件层的配置是应用自己的配置。

##### 三、配置中心的模型

1. 软件配置基本上来讲，每个配置项就是 key/value的模型。
2. 把软件的配置分成三层。操作系统层和平台层的配置项得由专门的运维人员或架构师来配置。其中的 value 应该是选项，而不是让用户可以自由输入的，最好是有相关的模板来初始化全套的配置参数。而应用层的配置项，需要有相应的命名规范，最好有像 C++ 那样的名字空间的管理，确保不同应用的配置项不会冲突。
3. 如果有 **外部服务依赖** 的配置，强烈建议不要放在配置中心里，而要放在 **服务发现系统** 中。
4. 对于不同运行环境中配置的差异来说，因为环境的不一样，会导致我们需要不同的配置项的值（例如：日志级别）。
5. 需要有一个整体的版本管理，每次变动都能将版本差异记录下来。如果可能，最好能和软件的版本号做关联。
6. 需要一个配置管理的工具，可能是命令行的，也可以是 Web 的。
7. 配置中心还需要提 API 来让应用获取配置。这个 API 上至少需要有如下参数：服务名，配置的版本号，配置的环境。

下图是配置管理工具的一个模型：

<img src="https://liuyang-picbed.oss-cn-shanghai.aliyuncs.com/img/5aeb4055738bd15188a007ccbbbc38b7.png" alt="5aeb4055738bd15188a007ccbbbc38b7" style="zoom:50%;" />

##### 四、配置中心的架构（落地）

<img src="https://liuyang-picbed.oss-cn-shanghai.aliyuncs.com/img/745c444c53457239de884a943adff1b5.png" alt="745c444c53457239de884a943adff1b5" style="zoom:67%;" />

在这个图中可以看到，我们把配置录入后，配置中心发出变更通知，配置变更控制器会来读取最新的配置，然后应用配置。



##### 五、配置中心的设计重点