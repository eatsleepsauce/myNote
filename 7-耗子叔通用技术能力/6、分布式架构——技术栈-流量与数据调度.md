#### 分布式系统的流量与数据调度

关于流量调度和服务治理，服务治理是内部系统的事，而流量调度可以是内部的，更是外部接入层的事。服务治理是数据中心的事，而流量调度要做得好，应该是数据中心之外的事，也就是我们常说的边缘计算，是应该在类似于 CDN 上完成的事。

##### 一、流量调度的主要功能

对于一个流量调度系统来说，其应该具有的主要功能是：

1. 依据系统运行的情况，自动地进行流量调度，在无需人工干预的情况下，提升整个系统的稳定性；
2. 让系统应对爆品等突发事件时，在弹性计算扩缩容的较长时间窗口内或底层资源消耗殆尽的情况下，保护系统平稳运行。

此外，这个流量调度系统还可以完成以下几方面的事情。

- **服务流控**，服务发现、服务路由、服务降级、服务熔断、服务保护等。
- **流量控制**，负载均衡、流量分配、流量控制、异地灾备(多活)等。
- **流量管理**，协议转换、请求校验、数据缓存、数据计算等。

**所有的这些都应该是一个 API Gateway 应该做的事。**

##### 二、流量调度等关键技术

因为要调度流量，首先需要扛住流量，而且还需要有一些比较轻量的业务逻辑，所以一个好的 API Gateway 需要具备以下的关键技术。

1. **高性能**

   API Gateway 必须使用高性能的技术，所以，也就需要使用高性能的语言。

2. **扛流量**

   要能扛流量，就需要使用集群技术。集群技术的关键点是在集群内的各个结点中共享数据。这就需要使用像 Paxos、Raft、Gossip 这样的通讯协议。因为 Gateway 需要部署在广域网上，所以还需要集群的分组技术。

3. **业务逻辑**

   API Gateway 需要有简单的业务逻辑，所以，最好是像 AWS 的 Lambda 服务一样，可以让人注入不同语言的简单业务逻辑。

4. **服务化**

   一个好的 API Gateway 需要能够通过 Admin API 来不停机地管理配置变更，而不是通过一个.conf 文件来人肉地修改配置。

##### 三、状态数据调度

###### 1、状态调度难点

对于服务调度来说，最难办的就是有状态的服务了。这里的状态是 State，也就是说，有些服务会保存一些数据，而这些数据是不能丢失的，所以，这些数据是需要随服务一起调度的。

###### 2、状态调度实现

一般来说，通过 **“转移问题”** 的方法来让服务变成“无状态的服务”。也就是说，会把这些有状态的东西存储到第三方服务上，比如 Redis、MySQL、ZooKeeper，或是 NFS、Ceph 的文件系统中。

这些“转移问题”的方式把问题转移到了第三方服务上，于是自己的 Java 或 PHP 服务中没有状态，但是 Redis 和 MySQL 上则有了状态。所以，现在的分布式系统架构中出问题的基本都是这些存储状态的服务。

因为数据存储结点在 Scale 上比较困难，所以成了一个单点的瓶颈。

###### 3、状态调度问题——分布式事务一致性的问题

要解决数据结点的 Scale 问题，也就是让数据服务可以像无状态的服务一样在不同的机器上进行调度，这就会涉及数据的 replication（自我复制） 问题。而数据 replication 则会带来数据一致性的问题，进而对性能带来严重的影响。

**要解决数据不丢失的问题，只能通过数据冗余的方法**，就算是数据分区，每个区也需要进行数据冗余处理。这就是数据副本。当出现某个节点的数据丢失时，可以从副本读到。**数据副本是分布式系统解决数据丢失异常的唯一手段**。简单来说：

- 要想让数据有高可用性，就得写多份数据。

- 写多份会引起数据一致性的问题。
- 数据一致性的问题又会引发性能问题。

在解决数据副本间的一致性问题时，我们有一些技术方案：

- Master-Slave方案
- Master-Master方案
- 两阶段和三阶段提交方案
- Paxos方案

更详细的解释《分布式系统的事务处理》  https://coolshell.cn/articles/10910.html

<img src="https://liuyang-picbed.oss-cn-shanghai.aliyuncs.com/img/e566933d9967f2f5e0f4dcddc66247ec.png" alt="e566933d9967f2f5e0f4dcddc66247ec" style="zoom:67%;" />

Latency 延迟。Throughput 吞吐 failover 故障

迄今为止，**在应用层上解决事务问题，只有“两阶段提交”这样的方式，而在数据层解决事务问题，Paxos 算法则是不二之选**。

###### 4、数据节点的分布式方案

真正解决数据结点调度的方案应该是底层的数据结点。在它们上面做这个事才是真正有效和优雅的。而像阿里的用于分库分表的数据库中间件 TDDL 或是别的公司叫什么 DAL 之类的这样的中间件都会成为过渡技术。

在 IaaS 层上解决这个问题，一般来说有三种方案，一种是使用比较廉价的开源产品，如：NFS、Ceph、TiDB、CockroachDB、ElasticSearch、InfluxDB、MySQL Cluster 和 Redis Cluster 之类的；另一种是用云计算厂商的方案。当然，如果不差钱的话，可以使用更为昂贵的商业网络存储方案。