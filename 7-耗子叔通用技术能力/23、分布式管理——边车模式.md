#### 边车模式 Sidecar

##### 一、边车模式

边车就有点像一个服务的 Agent，服务所有对外的进出通讯都通过这个 Agent 来完成。这样，就可以在这个 Agent 上做很多文章了。但是，需要保证的是，这个 Agent 要和应用程序一起创建，一起停用。

边车模式有时候也叫搭档模式，或是伴侣模式，或是跟班模式。**编程的本质就是将控制和逻辑分离和解耦**，而边车模式也是异曲同工，同样是让我们在分布式架构中做到逻辑和控制分离。

对于监视、日志、限流、熔断、服务注册、协议转换等等这些功能，其实都是大同小异，甚至是完全可以做成标准化的组件和模块的。一般来说，我们有两种方式。

- 一种是通过 SDK、Lib 或 Framework 软件包方式，在开发时与真实的应用服务集成起来。
- 另一种是通过像 Sidecar 这样的方式，在运维时与真实的应用服务集成起来。

这两种方式各有优缺点：

- 以软件包的方式可以和应用密切集成，有利于资源的利用和应用的性能，但是对应用有侵入，而且受应用的编程语言和技术限制。而且，当软件包升级的时候，需要重新编译并重新发布应用。
- 以 Sidecar 的方式，对应用服务没有侵入性，并且不用受到应用服务的语言和技术的限制，而且可以做到控制和逻辑的分开升级和部署。但是，这样一来，增加了每个应用服务的依赖性，也增加了应用的延迟，并且也会大大增加管理、托管、部署的复杂度。（对应老系统改造非常适合）

Sidecar本身的特性：

- Sidecar 服务在逻辑上和应用服务部署在一个结点中，其和应用服务有相同的生命周期。
- Sidecar 可以帮助服务注册到相应的服务发现系统，并对服务做相关的健康检查（移除不健康服务实列）。
- 当应用服务要调用外部服务时， Sidecar 可以帮助从服务发现中找到相应外部服务的地址，然后做服务路由。
- Sidecar 接管了进出的流量，可以做相应的日志监视、调用链跟踪、流控熔断……。
- 服务控制系统可以通过控制 Sidecar 来控制应用服务，如流控、下线等。

**使用了Sidecar模式，应用服务可以完全专注到业务逻辑上。**

<img src="https://liuyang-picbed.oss-cn-shanghai.aliyuncs.com/img/e30300b16a8fe0870ebfbec5a093b4f7.png" alt="img" style="zoom: 67%;" />

如果把 Sidecar 这个实例和应用服务部署在同一台机器中，那么

- Sidecar 的进程在理论上来说是可以访问应用服务的进程能访问的资源的。比如，Sidecar 是可以监控到应用服务的进程信息的。
- 因为两个进程部署在同一台机器上，所以两者之间的通信不存在明显的延迟。
- 这样的部署方式，最好是与 Docker 容器的方式一起使用的。

##### 二、设计重点

边车模式重点解决了：

- 控制和逻辑的分离。
- 服务调用中上下文的问题。

边车模式从概念上理解起来比较简单，但是在工程实现上来说，需要注意以下几点。

1. 进程间通讯机制是这个设计模式的重点，千万不要使用任何对应用服务有侵入的方式，比如，通过信号的方式，或是通过共享内存的方式。最好的方式就是网络远程调用的方式（因为都在 127.0.0.1 上通讯，所以开销并不明显）。

2. 服务协议方面，也请使用标准统一的方式。这里有两层协议，一个是 Sidecar 到 service 的内部协议，另一个是 Sidecar 到远端 Sidecar 或 service 的外部协议。

   (对于内部协议，需要尽量靠近和兼容本地 service 的协议；对于外部协议，需要尽量使用更为开放更为标准的协议。但无论是哪种，都不应该使用与语言相关的协议。)

3. 使用这样的模式，需要在服务的整体打包、构建、部署、管控、运维上设计好。使用 Docker 容器方面的技术可以帮助你全面降低复杂度。

4. Sidecar 中所实现的功能应该是控制面上的东西，而不是业务逻辑上的东西。

5. 小心在 Sidecar 中包含通用功能可能带来的影响。例如，重试操作，这可能不安全，除非所有操作都是幂等的。

6. 考虑允许应用服务和 Sidecar 的上下文传递的机制。 例如，包含 HTTP 请求标头以选择退出重试，或指定最大重试次数等等这样的信息交互。或是 Sidecar 告诉应用服务限流发生，或是远程服务不可用等信息，这样可以让应用服务和 Sidecar 配合得更好。

##### 三、适用场景和不适用场景

适用场景：

- 对老应用系统的改造和扩展。
- 对由多种语言混合出来的分布式服务系统进行管理和扩展。
- 应用服务由不同的供应商提供。
- 把控制和逻辑分离，标准化控制面上的动作和技术，从而提高系统整体的稳定性和可用性。

不适用场景：

- 架构并不复杂的时候，不需要使用这个模式，直接使用 API Gateway 或者 Nginx 和 HAProxy 等即可。
- 服务间的协议不标准且无法转换。
- 不需要分布式的架构。

