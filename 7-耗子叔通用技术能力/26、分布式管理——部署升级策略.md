#### 部署升级策略

在分布式系统的世界里，一个服务有多个实例，所以部署或是升级一个服务也会变得比较麻烦。今天我们讨论服务部署的模式。一般来说，有如下几种：

- **停机部署(Big Bang / Recreate)**：把现有版本的服务停机，然后部署新的版本。
- **蓝绿部署(Blue / Green / Stage)**：部署好新版本后，把流量从老服务那边切过来。
- **滚动部署(Rolling Update / Ramped)**：一点一点地升级现有的服务。
- **灰度部署(Canary)**：把一部分用户切到新版本上来，然后看一下有没有问题。如果没有问题就继续扩大升级，直到全部升级完成。
- **AB测试(A/B Testing)**：同时上线两个版本，然后做相关的比较。

##### 一、停机部署

停机部署其实是最简单粗暴的方式，就是简单地把现有版本的服务停机，然后部署新的版本。

**场景**：比如，新版本中的服务使用到了和老版本完全不兼容的数据表设计。这个时候，我们对生产有两个变更，一个是数据库，另一个是服务，而且新老版本互不兼容，所以只能使用停机部署的方式。

**优势**：在部署过程中不会出现新老版本同时在线的情况，所有状态完全一致。停机部署主要是为了新版本的一致性问题。

**缺点**：对用户的影响很大。所以，一般来说，这种部署方式需要事前挂公告，选择一个用户访问少的时间段来做。

##### 二、蓝绿部署

蓝绿部署与停机部署最大的不同是，其在生产线上部署相同数量的新服务，然后当新的服务测试确认 OK 后，把流量切到新的服务这边来。

**优势**：没有停机，实时发布和升级，也避免有新旧版本同时在线的问题。

**缺点**：浪费，因为需要双倍的资源，不过这只是在物理机时代，在云计算时代没事，因为虚拟机部署完就可以释放了。如果我们的服务中有状态，比如一些缓存什么的，停机部署和蓝绿部署都会有问题。

##### 三、滚动部署

滚动部署策略是指通过逐个替换应用的所有实例，来缓慢发布应用的一个新版本。通常过程如下：在负载调度后有个版本 A 的应用实例池，一个版本 B 的实例部署成功，可以响应请求时，该实例被加入到池中。然后，版本 A 的一个实例从池中删除并下线。

**优势**：对于有状态的服务也是比较友好的，状态可以在更新中慢慢重建起来。

**缺点**：

- 在发布过程中，会出现新老两个版本同时在线的情况，同一用户的请求可能在新老版中切换而导致问题。
- 新版程序没有在生产线上经过验证就上线了。
- 在整个过程中，生产环境处于一个新老更替的中间状态，如果有问题要回滚就有点麻烦了。
- 如果在升级过程中，需要做别的一些运维工作，我们还要判断哪些结点是老版本的，哪些结点是新版本的。这太痛苦了。
- 因为新老版本的代码同时在线，所以其依赖的服务需要同时处理两个版本的请求，这可能会带来兼容性问题。
- 而且，我们无法让流量在新老版本中切换。

##### 四、灰度部署（金丝雀）

灰度部署是指逐渐将生产环境流量从老版本切换到新版本。通常流量是按比例分配的。例如 90% 的请求流向老版本，10% 的请求流向新版本。然后没有发现问题，就逐步扩大新版本上的流量，减少老版本上的流量。

除了切流量外，对于多租户的平台，例如云计算平台，灰度部署也可以将一些新的版本先部署到一些用户上，如果没有问题，扩大部署，直到全部用户。一般的策略是，从内部用户开始，然后是一般用户，最后是大客户。

**场景**：这个技术大多数用于缺少足够测试，或者缺少可靠测试，或者对新版本的稳定性缺乏信心的情况下。

##### 五、AB测试

AB 测试和蓝绿部署或是金丝雀灰度部署完全是不一样的。

AB 测试是同时上线两个版本，然后做相关的比较。它是用来测试应用功能表现的方法，例如可用性、受欢迎程度、可见性等。

蓝绿部署是为了不停机，灰度部署是对新版本的质量没信心。而 AB 测试是对新版的功能没信心。注意，一个是质量，一个是功能。

**场景**：比如，网站 UI 大改版，推荐算法的更新，流程的改变，我们不知道新的版本否会得到用户青睐或是能得到更好的用户体验，需要收集一定的用户数据才能知道。

AB 测试，其包含了灰度发布的功能，对于灰度发布或是 AB 测试可以使用下面的技术来选择用户。

- **浏览器cookie**
- **查询参数**
- **地理位置**
- **技术支持，如浏览器版本、屏幕尺寸、操作系统等。**
- **客户端语言**

![1be6c93b43915e97a23d3c681daee909](https://liuyang-picbed.oss-cn-shanghai.aliyuncs.com/img/1be6c93b43915e97a23d3c681daee909-20210415213654263.png)

